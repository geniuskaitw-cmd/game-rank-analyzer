name: Data Analysis & Update
on:
  schedule:
    # æ¯é€±æ—¥ UTC æ™‚é–“ 00:00 (å°ç£æ™‚é–“ 08:00) åŸ·è¡Œä¸€æ¬¡
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # å…è¨±æ‰‹å‹•å¾ Actions åˆ†é åŸ·è¡Œæ­¤å·¥ä½œæµ

jobs:
  run_analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
        with:
          # å…è¨± actions/checkout ä½¿ç”¨ token ä¾†æäº¤æ›´æ”¹
          persist-credentials: false
          fetch-depth: 0 
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          # æ‚¨çš„è…³æœ¬éœ€è¦é€™äº›å‡½å¼åº« (å·²æ–°å¢ openai)
          pip install requests firebase-admin openai
          
      # === æº–å‚™ Firebase æ†‘è­‰æª”æ¡ˆ (Secrets) ===
      - name: Create Firebase Key File
        run: |
          # å°‡å¯†é‘°å…§å®¹å¯«å…¥ sync_overrides.py æ‰€éœ€çš„ firebase_key.json æª”æ¡ˆ
          echo '${{ secrets.FIREBASE_CRED_JSON }}' > scripts/firebase_key.json
          
      # === ä¾åºåŸ·è¡Œè…³æœ¬ (ç¢ºä¿è³‡æ–™æµå‘æ­£ç¢º) ===
      
      # 1. åŒæ­¥äººå·¥è¦†å¯«åˆ†é¡
      - name: 1. Run sync_overrides.py (Fetch Firebase overrides)
        run: python scripts/sync_overrides.py
        env:
          # è¨­å®šç’°å¢ƒè®Šæ•¸ï¼Œè®“ sync_overrides.py çŸ¥é“é‡‘é‘°æª”æ¡ˆçš„è·¯å¾‘
          FIREBASE_CRED_JSON: scripts/firebase_key.json
          
      # 2. æŠ“å–åŸå§‹æ¦œå–®æ•¸æ“šã€æ ¼å¼åŒ–ã€è¨ˆç®— delta
      - name: 2. Run fetch_ios_rss.py (Fetch Ranks)
        run: python scripts/fetch_ios_rss (4).py
        
      # 3. æ ¹æ“šè¦†å¯«å’Œ AI é‚è¼¯åˆ†é¡éŠæˆ² (å·²æ–°å¢ OPENAI_API_KEY)
      - name: 3. Run classify_games.py (Classify Ranks)
        run: python scripts/classify_games (2).py
        env:
          # å°‡ OpenAI é‡‘é‘°å‚³éçµ¦è…³æœ¬
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          
      # 4. åˆ†æåæ¬¡è®Šå‹•è€…
      - name: 4. Run analyze_rank_movers.py (Analyze Movers)
        run: python scripts/analyze_rank_movers (2).py
        
      # 5. åµæ¸¬ç‰ˆæœ¬æ›´æ–° (iOS API å‘¼å«)
      - name: 5. Run fetch_app_updates.py (Fetch App Updates)
        run: python scripts/fetch_app_updates (2).py

      # === æäº¤è®Šå‹• (å°‡ JSON æ•¸æ“šæ¨å›å„²å­˜åº«) ===
      - name: Commit and Push generated data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # åªæäº¤ data è³‡æ–™å¤¾ä¸­çš„å…§å®¹
          file_pattern: data/*
          commit_message: "ğŸ¤– Feat: Auto-generated data update"
          # ä½¿ç”¨é è¨­çš„ GitHub Token
          commit_user_name: GitHub Actions Bot
          commit_user_email: actions@github.com
