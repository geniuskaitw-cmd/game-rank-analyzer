name: Data Analysis & Update
on:
  schedule:
    # æ¯é€±æ—¥ UTC æ™‚é–“ 00:00 (å°ç£æ™‚é–“ 08:00) åŸ·è¡Œä¸€æ¬¡
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # å…è¨±æ‰‹å‹•å¾ Actions åˆ†é åŸ·è¡Œæ­¤å·¥ä½œæµ

jobs:
  run_analysis:
    runs-on: ubuntu-latest

    # === ä¿®æ­£ 1ï¼šè³¦äºˆå·¥ä½œ "å¯«å…¥" æ¬Šé™ ===
    permissions:
      contents: write
        
    steps:
      - name: 1. Checkout repository code
        uses: actions/checkout@v4
        with:
          # === ä¿®æ­£ 2ï¼šç§»é™¤ "persist-credentials: false" ===
          # ç¢ºä¿æ†‘è­‰è¢«ä¿ç•™ï¼Œä»¥ä¾¿ auto-commit-action å¯ä»¥æ¨é€
          fetch-depth: 0 
          
      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: 3. Install dependencies
        run: |
          # æ‚¨çš„è…³æœ¬éœ€è¦é€™äº›å‡½å¼åº«
          pip install requests firebase-admin openai
          
      # === æº–å‚™ Firebase æ†‘è­‰æª”æ¡ˆ (Secrets) ===
      - name: 4. Create Firebase Key File
        run: |
          # å°‡å¯†é‘°å…§å®¹å¯«å…¥ sync_overrides.py æ‰€éœ€çš„ firebase_key.json æª”æ¡ˆ
          echo '${{ secrets.FIREBASE_CRED_JSON }}' > scripts/firebase_key.json
          
      # === ä¾åºåŸ·è¡Œè…³æœ¬ (ä½¿ç”¨ä¿®æ­£å¾Œçš„æ­£ç¢ºæª”å) ===
      
      # 5. åŒæ­¥äººå·¥è¦†å¯«åˆ†é¡
      - name: 5. Run sync_overrides.py (Fetch Firebase overrides)
        run: python scripts/sync_overrides.py
        env:
          # è¨­å®šç’°å¢ƒè®Šæ•¸ï¼Œè®“ sync_overrides.py çŸ¥é“é‡‘é‘°æª”æ¡ˆçš„è·¯å¾‘
          FIREBASE_CRED_JSON: scripts/firebase_key.json
          
      # 6. æŠ“å–åŸå§‹æ¦œå–®æ•¸æ“šã€æ ¼å¼åŒ–ã€è¨ˆç®— delta
      - name: 6. Run fetch_ios_rss.py (Fetch Ranks)
        run: python scripts/fetch_ios_rss.py
        
      # 7. æ ¹æ“šè¦†å¯«å’Œ AI é‚è¼¯åˆ†é¡éŠæˆ²
      - name: 7. Run classify_games.py (Classify Ranks)
        run: python scripts/classify_games.py
        env:
          # å°‡ OpenAI é‡‘é‘°å‚³éçµ¦è…³æœ¬
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          
      # 8. åˆ†æåæ¬¡è®Šå‹•è€…
      - name: 8. Run analyze_rank_movers.py (Analyze Movers)
        run: python scripts/analyze_rank_movers.py
        
      # 9. åµæ¸¬ç‰ˆæœ¬æ›´æ–° (iOS API å‘¼å«)
      - name: 9. Run fetch_app_updates.py (Fetch App Updates)
        run: python scripts/fetch_app_updates.py

      # === æäº¤è®Šå‹• (å°‡ JSON æ•¸æ“šæ¨å›å„²å­˜åº«) ===
      - name: 10. Commit and Push generated data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # åªæäº¤ data è³‡æ–™å¤¾ä¸­çš„å…§å®¹
          file_pattern: data/*
          commit_message: "ğŸ¤– Feat: Auto-generated data update"
          # ä½¿ç”¨é è¨­çš„ GitHub Token
          commit_user_name: GitHub Actions Bot
          commit_user_email: actions@github.com

